# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Vue 3 + TypeScript frontend application for MarketWatch, integrating with an ABP Framework backend via OAuth authentication. The app displays stock market data, charts, and trading strategies.

The backend code is at ../MarketWatchWeb_AbpBackEnd
The backend code uses Abp Framework
EF core is used with migration. Do not manually update migration file, which should be generated by migration tool.

### Multi-Solution Database Architecture

**CRITICAL: Three codebases share the same database (`marketwatch_Prod`):**

1. **MarketWatchCore** (at `../MarketWatchCore`) - Core simulation/backtesting engine
2. **MarketWatchWeb_AbpBackEnd** (at `../MarketWatchWeb_AbpBackEnd`) - ABP Framework web API
3. **MarketWatchFrontEnd-Vue** (this repo) - Vue 3 frontend

**Schema Ownership Rules:**

| Solution            | Role               | Entity Framework | Migrations                         |
| ------------------- | ------------------ | ---------------- | ---------------------------------- |
| **MarketWatchCore** | **Schema Owner**   | EF Core 8        | **✅ Owns all migrations**         |
| **ABP Backend**     | Consumer/API Layer | EF Core 8        | ❌ No migrations for shared tables |
| **Vue Frontend**    | Consumer           | N/A              | N/A                                |

**Shared Tables (Owned by MarketWatchCore):**

- `Companys`, `StockInfo`, `StockPrice` - Stock market data
- `strategy`, `backtestHistory` - Simulation strategies
- `refStrategyType`, `refSellType` - Reference data

**MarketWatchCore-Exclusive Tables:**

- `coefficient_pair` - Cached correlation pairs
- `correlation_cache` - Correlation/cointegration cache
- `indicator_cache` - Technical indicator cache

**ABP-Exclusive Tables:**

- `OptimizationJobs`, `SimulationQueue` - Parameter optimization system
- `tblFundStrategy`, `tblFundTradeHistory` - Live trading strategies
- ABP framework tables (Users, Roles, Audit logs, etc.)

**Important:**

- **All schema changes for shared tables MUST go through MarketWatchCore migrations**
- ABP Backend entities mirror MarketWatchCore's schema for shared tables
- When adding/modifying shared entities, update MarketWatchCore first, then sync ABP Backend
- ABP Backend creates migrations ONLY for its exclusive tables (OptimizationJobs, SimulationQueue, etc.)
- Do NOT create migrations in ABP Backend for shared tables

## Agent instruction

- Always create a todo list and process it one by one
- Choose the simplest solution
- After implementation, update CLAUDE.md if needed. CLAUD.md needs to to high-level and concise

## Development Commands

**Development server:**

```bash
npm run dev
```

Runs on https://localhost:4200 with auto-generated SSL certificates (via vite-plugin-mkcert)

**Build for production:**

```bash
npm run build
```

Runs type checking in parallel with the Vite build

**Type checking only:**

```bash
npm run type-check
```

**Linting:**

```bash
npm run lint
```

Auto-fixes issues where possible

**Testing:**

```bash
npm run test:unit              # Run Vitest unit tests
npm run test:e2e               # E2E tests with Cypress (interactive)
npm run test:e2e:ci            # E2E tests (headless)
```

## Architecture

### Authentication Flow

- OAuth/OIDC authentication via `vue-oidc-client` library
- Identity server configured in [src/core/config/globalConfig.ts](src/core/config/globalConfig.ts) (`APIServer: "https://localhost:44324"`)
- Authentication setup in [src/idsrvAuth.ts](src/idsrvAuth.ts) - creates OIDC auth instance with ABP-specific configuration
- App initialization in [src/main.ts](src/main.ts) waits for `idsrvAuth.startup()` before mounting
- Protected routes require `meta.authName` set to `idsrvAuth.authName` in router config

### API Communication

- Centralized API service: [src/core/services/apiService.ts](src/core/services/apiService.ts)
- Automatically injects Bearer token from OIDC auth into all axios requests
- Base URL configured via `GlobalConfig.APIServer`
- Methods: `get()`, `post()`, `update()`, `delete()`
- marketWatchClient.ts is auto-generated from backend. Run "G:\SourceCode\MarketWatchWeb_AbpBackEnd\src\MarketWatchWeb.HttpApi.Host\CreateClient.bat"

### Directory Structure

```
src/
├── core/
│   ├── config/          # Global configuration (API endpoints)
│   └── services/        # API service layer
├── views/               # Page components (HomeView, StockPrice, StockChart, etc.)
├── components/          # Reusable components
│   ├── PageHeader.vue   # Consistent page header with title, subtitle, search, and actions
│   ├── StatusBadge.vue  # Colored status badges (active, pending, cancelled, delay)
│   ├── FilterBar.vue    # Filter controls for tables
│   └── HeaderComponent.vue  # Main navigation header
├── router/              # Vue Router configuration
├── assets/              # Static assets, CSS (including main.css for Tailwind)
├── idsrvAuth.ts         # OIDC authentication setup
├── main.ts              # App initialization and plugin registration
└── vue-oidc-client.ts   # OIDC client wrapper
```

### Styling

- Tailwind CSS v4 (requires `@tailwindcss/postcss` plugin in [postcss.config.js](postcss.config.js))
- Element Plus UI library globally registered
- PrimeVue components available
- Modern table styling with:
  - Subtle borders and hover effects
  - Consistent filter bars with search, dropdowns, and action buttons
  - Status badges with colored dots (green=Active, orange=Pending, red=Cancelled, purple=Delay)
  - Clean typography and spacing
  - Responsive design patterns

### Routing

Protected routes (all except home) require authentication and use lazy loading for code splitting.

### Data Entities

- **Company** entity mapped to `Companys` table - provides comprehensive financial data (market cap, P/E ratio, EPS, sector, etc.)
- **StockInfo** entity for basic stock information
- **StockPrice** entity for historical price data

Recent additions:

- `GET /strategyHistory` route renders Strategy trade history list (from `tblFundTradeHistory`)
- StockChart page now displays financial overview section with key metrics from Company entity
- `/strategy` route (StrategyView) uses `tblFundStrategy` with Name column and Edit functionality
- `/simulate/strategy` route (SimulateStrategy) uses `Strategy` table for simulation strategies
- **Parameter Optimization System** - Automated parameter optimization with background job queue (see below)
- **Indicator-Based Strategies** - Technical indicator-driven trading strategies alongside pair-trading (see below)

## Key Configuration Files

- [vite.config.ts](vite.config.ts) - Vite config with HTTPS enabled, alias `@` → `./src`
- [postcss.config.js](postcss.config.js) - PostCSS with Tailwind v4 (`@tailwindcss/postcss`)
- [tsconfig.json](tsconfig.json), [tsconfig.app.json](tsconfig.app.json), [tsconfig.vitest.json](tsconfig.vitest.json) - TypeScript configs

## Coding Standards

- Vue 3 Composition API with TypeScript
- Use Tailwind CSS for styling
- Keep implementations simple and straightforward
- Do not create a EF migration. Skip it.

## Parameter Optimization System

**Purpose:** Automatically find the best strategy parameters by testing hundreds of combinations systematically.

### Architecture

- **Backend** (ABP Framework):

  - `OptimizationJob` entity - Stores optimization job configuration and results
  - `SimulationQueue` entity - Individual simulations in the queue
  - `OptimizationJobAppService` - Creates jobs, generates parameter combinations
  - `SimulationQueueWorker` - Background worker that runs simulations asynchronously
  - Tables: `OptimizationJobs`, `SimulationQueue`

- **Frontend** (Vue 3):
  - `/optimization/config` - Configure and start new optimization jobs
  - `/optimization/monitor` - Monitor running jobs and view results
  - Integration with existing `/simulate/run` page to use optimized parameters

### Optimization Methods

1. **Smart Grid Search** (Recommended) - Seeds from top historical performers, then coarse grid
2. **Walk-Forward Analysis** - Rolling time windows to prevent overfitting
3. **Grid Search** - Exhaustive parameter combination testing

### Parameters Optimized

- Analysis Period, Correlation Threshold, Entry Trigger, Stop Loss
- Portfolio Size, Trade Fee, Slippage, Trend Filter settings

### Usage Flow

1. Configure optimization (method, parameter ranges, date range)
2. System generates 100-500 simulation combinations
3. Background worker processes queue (one at a time)
4. Monitor dashboard shows real-time progress
5. Review top 10 performers sorted by Sharpe ratio
6. Click "Use These" to apply best parameters to Run Simulation

### Setup Required

1. Create EF migration for new tables (see `../MarketWatchWeb_AbpBackEnd/OPTIMIZATION_SETUP.md`)
2. Run migration to create database tables
3. Regenerate TypeScript client (`CreateClient.bat`)
4. Update frontend views to use generated API clients instead of mock data

### External Dependencies

- Simulation service at `http://localhost:52335/api/Simulation/run`
- Background worker polls queue every 5 seconds
- Results stored in database for analysis

## Indicator-Based Strategies

**Purpose:** Trade single stocks using technical indicators (RSI, MACD, Bollinger Bands) instead of correlation/cointegration relationships between stock pairs.

### Strategy Types (StrategyType Enum)

| ID  | Strategy                 | Type               | Mechanism                                                | Use Case                                                    |
| --- | ------------------------ | ------------------ | -------------------------------------------------------- | ----------------------------------------------------------- |
| 0   | **Correlation**          | Two-stock pairs    | Exploits synchronous co-movement divergences             | Mean reversion when stocks deviate from normal relationship |
| 1   | **MeanReversion**        | Two-stock pairs    | Long-term equilibrium relationships                      | Statistical arbitrage with stronger long-term bonds         |
| 2   | **Momentum**             | Single/multi stock | Trend-following                                          | Capitalize on continuing price trends                       |
| 3   | **LeadLag**              | Two-stock pairs    | Temporal relationship                                    | One stock leads another's movement                          |
| 4   | **MomentumContinuation** | Single/multi stock | Extended momentum                                        | Sustained trend exploitation                                |
| 5   | **IndicatorBased**       | Single stock       | Technical indicator signals (RSI, MACD, Bollinger Bands) | Mean reversion and momentum on individual stocks            |

### Available Indicators

1. **RSI (Relative Strength Index)**

   - Momentum oscillator measuring oversold/overbought conditions
   - Range: 0-100
   - Typical thresholds: <30 (oversold buy signal), >70 (overbought sell signal)
   - Default period: 14 days

2. **MACD (Moving Average Convergence Divergence)**

   - Trend-following momentum indicator
   - Measures difference between fast (12-day) and slow (26-day) exponential moving averages
   - Signals generated when MACD crosses signal line
   - Default period: 26 days

3. **Bollinger Bands**
   - Volatility bands placed above/below moving average
   - Identifies price extremes and mean reversion opportunities
   - Default period: 20 days
   - Threshold: Number of standard deviations from mean (typically 2.0)

### UI Configuration in SimulateRunView.vue

**Strategy Selection**:

- IndicatorBased is a top-level strategy type (ID=5) in the strategy dropdown
- Selecting IndicatorBased shows indicator-specific fields (Primary Indicator, Indicator Period)
- Selecting pair-trading strategies (Correlation, MeanReversion) shows Analysis Method (Correlation/Cointegration)

**Indicator Configuration Fields**:

- **Primary Indicator**: Dropdown with RSI, MACD, Bollinger Bands
- **Indicator Period**: InputNumber (2-200 days)
- Smart defaults set automatically when indicator selection changes

**Dynamic Labels** (computed properties):

- `investTriggerRateLabel` changes based on mode (Indicator Threshold vs. Entry Trigger %)
- `investTriggerRateHint` provides context-specific guidance (RSI: oversold level, MACD: signal threshold, etc.)

### Usage Examples

**RSI Mean Reversion Strategy:**

1. Strategy Type: IndicatorBased
2. Primary Indicator: RSI (Relative Strength Index)
3. Indicator Period: 14
4. Indicator Threshold: 30 (buy when RSI < 30)
5. Stop Loss: -1% (exit losing trades at 1% loss)
6. Run simulation across selected stocks

**Bollinger Bands Breakout Strategy:**

1. Strategy Type: IndicatorBased
2. Primary Indicator: Bollinger Bands
3. Indicator Period: 20
4. Indicator Threshold: 2 (trade when price 2 std devs from mean)
5. Portfolio Size: 15 stocks
6. Analyze daily signals across 1-year historical period

**Parameter Ranges** (typical starting values):

- **RSI**: Period 10-21, Threshold 20-40 (oversold) or 60-80 (overbought)
- **MACD**: Period 20-30, Threshold varies by stock volatility (-0.5 to 0.5)
- **Bollinger Bands**: Period 15-25, Standard deviations 1.5-2.5

### Backend Integration

**API Request** (SimulateRunView.vue):

- `strategyType`: 5 (IndicatorBased) — sent as the strategy type enum value
- `primaryIndicator`: String identifier (RSI, MACD, BollingerBands)
- `indicatorPeriod`: Number of periods for calculation
- `investTriggerRate`: Threshold value specific to each indicator
- All sent to `POST /api/Simulation/run` at `http://localhost:52335`

**Backend Processing**:

- MarketWatchCore's `IndicatorStrategyBase` evaluates indicator signals
- Single stock or portfolio-level analysis based on parameters
- Results identical format as pair-trading (return, Sharpe ratio, trades list)

### Indicator Cache System

**Two-Tier Caching** (MarketWatchCore):

- **L1 Memory Cache**: Calculation results cached in process for repeated periods
- **L2 Database Cache**: Persistent `indicator_cache` table for historical lookups
- **Performance**: 10-1300x speedup compared to recalculating indicators

**Cache Tables**:

- `indicator_cache` - Stores precomputed RSI, MACD, Bollinger Bands values
- Owned by MarketWatchCore (migrations in MarketWatchCore only)
- Automatically populated during simulations

### Data Flow

1. **Frontend** → User selects indicator and period in SimulateRunView.vue
2. **API** → Request includes `primaryIndicator`, `indicatorPeriod`, `investTriggerRate`
3. **Backend** → Routes to IndicatorStrategyBase implementation
4. **Calculation** → Checks L1 cache, then L2 database cache, calculates if needed
5. **Results** → Returns trades, metrics, and performance summary
6. **Display** → Trades rendered in same table format as pair-trading strategies

### Switching Between Strategy Types

**From Pair-Trading to Indicator-Based**:

- Selecting IndicatorBased from strategy dropdown clears `coefficientAllowed` to 0
- Sets `primaryIndicator` to 'RSI' (default)
- Sets `indicatorPeriod` to 14
- Sets `investTriggerRate` to 30 (RSI oversold level)

**From Indicator-Based to Pair-Trading**:

- Selecting a pair-trading strategy clears indicator fields (`primaryIndicator`, `indicatorPeriod` → null)
- Restores `coefficientAllowed` to 0.80 (default correlation threshold)
- Restores `investTriggerRate` to 0.02 (default entry trigger %)

## log

- backend log file is at "G:\SourceCode\MarketWatchWeb_AbpBackEnd\src\MarketWatchWeb.HttpApi.Host\Logs\logs.txt"
